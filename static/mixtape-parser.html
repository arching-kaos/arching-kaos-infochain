<!DOCTYPE html>
<html>
	<head>
		<title>ArchingKaos Radio based on Infochain Parser</title>
		<meta charset="utf8"/>
		<meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
		<link rel="icon" href="//ipfs.arching-kaos.com/ipfs/QmagKP1zLWaGHLR4191dpvsCYHS8tuPCRYJgfK9Zdr6i9S?filename=favicon-48x48.97046865.png">
		<link href="//ipfs.arching-kaos.com/ipfs/QmexPMNB2E9YdXgNusRgoFvBnKerq5uEdRGEzyDAfZFiLH?filename=styles.css" rel="stylesheet">
		<style>
			.details {background-color:#2a2a2a;padding:2%;font-size:75%;}
			.mixtape {background-color:#3a3a3a;padding:1%;font-size:100%;}
		</style>
	</head>
	<body>
		<header>
			<img src="//ipfs.arching-kaos.com/ipfs/QmagKP1zLWaGHLR4191dpvsCYHS8tuPCRYJgfK9Zdr6i9S?filename=arching-kaos-logo.png">
			<img style="width:128px" src="//ipfs.arching-kaos.com/ipfs/QmaChNYtkzH4k4j9Z3jdVFQKDrPnv11eRReFyAHs5iL9pV?filename=arching-kaos-radio-logo-animated.gif">
			<h1>Arching Kaos Radio</h1>
			<p>Fully decentralized and distributed version</p>
		</header>
		<h2>Mixtapes</h2>
		<div id="results">
		</div>
		<div class="container"></div>
		<div class="donations">
			<h3>Donations</h3>
			<p>Stellar:GCHSUH6TBKKY37EBPCIPBLYG42L5M7LE5UBUV3IEZVUIAXNCR4CR4ZMW</p>
		</div>
		<hr>
		<div class="footer">
			Powered by&nbsp;<a href="https://www.kaotisk-hund.com">Kaotisk Hund</a>.
		</div>
	</body>
	<script type="application/javascript" src="../QmcbR9LDKhDquP1yruQXbxztEUGmrCALfkjE6yBjasjfDs/openpgp.min.js"></script>
	<script>
		var gateway = "//ipfs.arching-kaos.com/ipfs/"
		var stellarExpert = "https://stellar.expert/explorer/public/account/"
		var stellarOperation = "https://stellar.expert/explorer/public/tx/"
		var some =""
		var template=""
		var mixtapes=[]
		var indexedZBLOCK=[]
		var indexedLTX=[]
		function gurl(ipfs){
			return gateway.concat(ipfs)
		}
		function staccurl(a){
			return stellarExpert.concat(a)
		}
		function sttx(a){
			return stellarOperation.concat(a)
		}
		function toggleDetails(t){(t.children[1].hidden===true?t.children[1].hidden=false:t.children[1].hidden=true)}
		function zblockGrab(url){
			fetch(url, {
				method:'GET',
				headers:{
					Accept: 'application/json'
				}
			}).then(response=>{
				if(response.ok){
					response.json().then(json=>{
						return json.block
					})
				}
			})
		}
		async function getzblock(u,r,iv){
			console.log("Getting ZBLOCK: ",r)
			try{
				let res = await fetch(u);
				res.json().then(v=>getblock(gurl(v.block),v,r,iv))
			}
			catch (error) {
				console.log(error)
			}
		}
		async function getblock(u,zblock,zblockCID,iv){
			console.log("Getting BLOCK: ",zblock.block,", from ZBLOCK: ",zblockCID)
			try{
				let res = await fetch(u);
				res.json().then(v=>getaction(v,zblock,zblockCID,iv))
			}
			catch (error) {
				console.log(error)
			}
		}
		async function getaction(block, zblock, zblockCID,iv){
			console.log("Getting action on: ",block,zblock.block,zblockCID)
			try{
				if(block.action === 'mixtape/add'){
					let res = await fetch(gurl(block.data));
					res.json().then(v=>indexMixtape(v,block,zblock,zblockCID,iv))
				}
			}
			catch (error) {
				console.log(error)
			}
		}
		async function indexMixtape(data,block,zblock,zblockCID,iv){
			tx = txs[findLatestTransactionFromZblockCID(zblockCID, iv)]
			atx = findTransactionsFromZBLOCKCID(zblockCID,iv)
			ab = txs[atx[4]]
			ac = txs[atx[3]]
			ad = txs[atx[2]]
			bc = txs[atx[1]]
			bd = txs[atx[0]]
			mixtape = {
				"zblock":zblockCID,
				"block":zblock.block,
				"blocksignature":zblock.block_signature,
				"ltx": tx.tx,
				"from": tx.from,
				"to": tx.to,
				"memo": tx.memo,
				"ab": ab,
				"ac": ac,
				"ad": ad,
				"bc": bc,
				"bd": bd,
				"action": block.action,
				"data":block.data,
				"artist":data.artist,
				"title":data.title,
				"file":data.ipfs,
				"filesig":data.detach,
				"datasig":block.detach,
				"gpg":block.gpg,
				"previous":block.previous
			}
			indexZBLOCK(mixtape)
			mixtapes.push(mixtape)
			showMixtape(mixtape)
		}
		function indexZBLOCK(z){
			x = [
				z.ltx,
				z.memo,
				[
					z.ab,
					z.ac,
					z.ad,
					z.bc,
					z.bd
				],
				z.zblock,
				z.block,
				[
					z.action,
					z.data,
					[
						z.artist,
						z.title,
						z.file,
						z.filesig
					],
					z.datasig,
					z.gpg,
					z.previous
				]
			]
			return x
		}
		/*
		 * Gets a mixtape type data and shows it to the .container div element.
		 * @param mx
		 */
		function showMixtape(mx){
			console.log("Working on: ",mx)
			template = `
				<div class="mixtape" id="${mx.zblock}">
					<h3>${mx.artist} - ${mx.title}</h3>
					<audio controls="">
						<source src="${gurl(mx.file)}">
					</audio>
					<div class="details-container" onclick="toggleDetails(this)">
					<h4>Details</h4><p><em>(click to expand/hide)</em></p>
					<div class="details">
						<h5>Infochain</h5>
						<p>ZBLOCK: <a href="${gurl(mx.zblock)}">${mx.zblock}</a></p>
						<p>BLOCK: <a href="${gurl(mx.block)}">${mx.block}</a></p>
						<p>BLOCK signature: <a href="${gurl(mx.blocksignature)}">${mx.blocksignature}</a></p>
						<p>Key is <a href="${gurl(mx.gpg)}">${mx.gpg}</a></p>
						<p>Data signature: <a href="${gurl(mx.datasig)}">${mx.datasig}</a></p>
						<p>File signature: <a href="${gurl(mx.filesig)}">${mx.filesig}</a></p>
						<p>Previous: <a href="${gurl(mx.previous)}">${mx.previous}</a></p>
						<h5>Transaction details</h5>
						<p>BD transaction <a href="${sttx(bd.tx)}">${bd.tx}</a> with memo:"${bd.memo}" on ${bd.ts}</p>
						<p>Contributor <a href="${staccurl(bd.from)}">${bd.from}</a> to <a href="${staccurl(bd.to)}">${bd.to}</a></p>
						<p>BC transaction <a href="${sttx(bc.tx)}">${bc.tx}</a> with memo:"${bc.memo}" on ${bc.ts}</p>
						<p>Contributor <a href="${staccurl(bc.from)}">${bc.from}</a> to <a href="${staccurl(bc.to)}">${bc.to}</a></p>
						<p>AD transaction <a href="${sttx(ad.tx)}">${ad.tx}</a> with memo:"${ad.memo}" on ${ad.ts}</p>
						<p>Contributor <a href="${staccurl(ad.from)}">${ad.from}</a> to <a href="${staccurl(ad.to)}">${ad.to}</a></p>
						<p>AC transaction <a href="${sttx(ac.tx)}">${ac.tx}</a> with memo:"${ac.memo}" on ${ac.ts}</p>
						<p>Contributor <a href="${staccurl(ac.from)}">${ac.from}</a> to <a href="${staccurl(ac.to)}">${ac.to}</a></p>
						<p>AB transaction <a href="${sttx(ab.tx)}">${ab.tx}</a> with memo:"${ab.memo}"on ${ab.ts}</p>
						<p>Contributor <a href="${staccurl(ab.from)}">${ab.from}</a> to <a href="${staccurl(ab.to)}">${ab.to}</a></p>
					</div>
					<p id="gotop-link"><a href="#top"><span class="mdi mdi-arrow-up"></span> Top</a></p><hr>	
				</div>`	
			let base = document.querySelector(".container")
			base.innerHTML+=template
		}
		function findLatestTransactionFromZblockCID(zblockCID,iv){
			for (i in iv){
				if (iv[i][0] === zblockCID){
					return iv[i][2]
				}
			}
		}
		function findTransactionsFromZBLOCKCID(z,iv){
			for (i in iv){
				if (iv[i][0] === z){
					return [iv[i][2],iv[i][4],iv[i][6],iv[i][8],iv[i][10]]
				}
			}
		}
		function findTransaction(bd,txs){
			for (tx in txs){
				if (txs[tx].memo === bd){
					return tx
				}
			}
		}
		function gatherMixtapes(res,iv){
			for (r in res){
				getzblock(gurl(res[r]),res[r],iv)
			}
		}
		let txs = []
		fetch('//api.stellar.expert/explorer/public/payments?asset=ARCHINGKAOS-GB4QVKD6NW3CSNO5TNPARAWNPPXOPSSTKB35XCWB7PUNBIQTK3DVELB2&order=des&limit=2000')
		.then(respone=>respone.json())
		.then(data=>{
			txs=data._embedded.records
			ones = []
			twos = []
			tres = []
			fors = []
			fivs = []
			vals = []
			resu = []
			iv = []
			for (y in txs){
				if (typeof txs[y].memo !== 'undefined'){
					x=txs[y].memo
					if (x.startsWith("...")){
						if (x.endsWith("..")){
							if (x.endsWith("...")){
								tres.push(x)
							} else {
								twos.push(x)
							}
						} else {
							ones.push(x)
						}
					} else {
						if (x.endsWith("...")){
							fivs.push(x)
						} else {
							fors.push(x)
						}
					}
				} else {
					console.log("transaction ",txs[y]," skipped")
				}
			}
			for (n in ones){
				for (tw in twos){
					for (tr in tres){
						if (ones[n].substr(0,14) == twos[tw].substr(0,14) && ones[n].substr(0,14) == tres[tr].substr(0,14)){
							console.log("found")
							for (fo in fors){
								for (fi in fivs){
									if (ones[n].substr(14) == fors[fo].substr(0,14) && ones[n].substr(14) == fivs[fi].substr(0,14)){
										console.log("Validated")
										val=ones[n].concat(twos[tw].substr(14),tres[tr].substr(14))
										vals.push(val)
										resu.push(val.replace(/\./g,""))
										console.log(val.replace(/\./g,""))
										iv.push([val.replace(/\./g,""), fivs[fi], findTransaction(fivs[fi],txs), fors[fo],findTransaction(fors[fo],txs), tres[tr],findTransaction(tres[tr],txs), twos[tw],findTransaction(twos[tw],txs), ones[n],findTransaction(ones[n],txs)])
									}
								}
							}
						}
					}
				}
			}
			gatherMixtapes(resu,iv)
		})
	</script>
</html>
