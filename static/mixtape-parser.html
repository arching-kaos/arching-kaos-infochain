<!DOCTYPE html>
<html>
    <head>
    <title>ArchingKaos Radio based on Infochain Parser</title>
    <meta charset="utf8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <link href="//127.0.0.1:8080/ipfs/Qmeq8yoyf7PX4ia8qtPPxMwbxzGtLURUE5GcfQX35tqFBp" rel="stylesheet">
    </head>
    <body>
        <h1>Arching Kaos Radio</h1>
        <h3>Fully decentralized and distributed version</h3>

    <p>Mixtapes</p>
    <div id="results">
    </div>
    <div class="container"></div>
    </body>
    <script>
	    var gateway = "//127.0.0.1:8080/ipfs/"
	    function gurl(ipfs){
				return gateway.concat(ipfs)
			}
	    function zblockGrab(url){
				fetch(url, {
						    method:'GET',
						    headers:{
									Accept: 'application/json'
								}
					    }).then(response=>{
								if(response.ok){
										    response.json().then(json=>{
													return json.block
							})}})
			}
	    async function zblock(u){
				try{
						    let res = await fetch(u);
						    res.json().then(v=>block(gurl(v.block)))
					    }
				catch (error) {console.log(error)}
			}
	    async function block(u){
				try{
						    let res = await fetch(u);
						    res.json().then(v=>actioner(v))
					    }
				catch (error) {console.log(error)}
			}
	    async function actioner(block){
				try{
						    if(block.action === 'mixtape/add'){
									let res = await fetch(gurl(block.data));
									res.json().then(v=>showMixtape(v))
								}
					    }
				catch (error) {console.log(error)}
			}
	    function showMixtape(data){
				some = ''
	   			template = `
					<div>
					<h5>${data.artist} - ${data.title}</h5>
					<audio controls="">
					<source src="${gurl(data.ipfs)}">
					</audio>
				`
				some += template
				let base = document.querySelector(".container")
				base.innerHTML=some

			}
	    function gatherMixtapes(res){
				for (r in res){
						    console.log(zblock(gurl(res[r])))
        }
    }
    let txs = []
    fetch('//api.stellar.expert/explorer/public/payments?asset=ARCHINGKAOS-GB4QVKD6NW3CSNO5TNPARAWNPPXOPSSTKB35XCWB7PUNBIQTK3DVELB2&order=asc&limit=2000')
    .then(respone=>respone.json())
    .then(data=>{
        txs=data._embedded.records
        ones = []
        twos = []
        tres = []
        fors = []
        fivs = []
        vals = []
        resu = []
        for (y in txs)
        {
            if (typeof txs[y].memo !== 'undefined')
            {
                x=txs[y].memo
                if (x.startsWith("..."))
                {
                    if (x.endsWith(".."))
                    {
                        if (x.endsWith("..."))
                        {
                            tres.push(x)
                        }
                        else
                        {
                            twos.push(x)
                        }
                    }
                    else
                    {
                        ones.push(x)
                    }
                }
                else
                {
                    if (x.endsWith("..."))
                    {
                        fivs.push(x)
                    }
                    else
                    {
                        fors.push(x)
                    }
                }
            }
            else
            {
                console.log("transaction skipped")
            }
        }
        for (on in ones){
        for (tw in twos){
        for (tr in tres){
            if (ones[on].substr(0,14) == twos[tw].substr(0,14) && ones[on].substr(0,14) == tres[tr].substr(0,14)){
            console.log("found")
            for (fo in fors){
                for (fi in fivs){
                if (ones[on].substr(14) == fors[fo].substr(0,14) && ones[on].substr(14) == fivs[fi].substr(0,14)){
                    console.log("Validated")
                    val=ones[on].concat(twos[tw].substr(14),tres[tr].substr(14))
                    vals.push(val)
                    resu.push(val.replace(/\./g,""))
                    console.log(val.replace(/\./g,""))
                }
                }
            }
            }
        }
            }
        }
//        for (r in resu){
//            some = document.createElement("p")
//            inne = document.createTextNode(resu[r])
//            some.appendChild(inne)
//            base = document.getElementById("results")
//            base.appendChild(some)
//        }
    gatherMixtapes(resu)
})</script>
</html>
